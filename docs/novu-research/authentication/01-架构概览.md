# Novu 身份认证机制 - 架构概览

## 一、认证模块结构

### 1.1 目录结构

```
apps/api/src/app/auth/
├── auth.controller.ts              # 认证控制器（登录、注册、密码重置等）
├── auth.module.ts                  # 认证模块（动态加载社区版/企业版）
├── community.auth.module.config.ts # 社区版认证模块配置
├── ee.auth.module.config.ts        # 企业版认证模块配置
├── dtos/                           # 数据传输对象
│   ├── login.dto.ts
│   ├── user-registration.dto.ts
│   ├── password-reset.dto.ts
│   └── update-password.dto.ts
├── framework/                      # 认证框架组件
│   ├── auth.decorator.ts           # @RequireAuthentication 装饰器
│   ├── community.user.auth.guard.ts# 社区版用户认证守卫
│   ├── external-api.decorator.ts   # @ExternalApiAccessible 装饰器
│   └── root-environment-guard.service.ts
├── services/
│   ├── auth.service.ts             # 认证服务代理
│   ├── community.auth.service.ts   # 社区版认证服务实现
│   └── passport/                   # Passport 认证策略
│       ├── jwt.strategy.ts         # JWT 策略
│       ├── apikey.strategy.ts      # API Key 策略
│       ├── subscriber-jwt.strategy.ts # 订阅者 JWT 策略
│       └── github.strategy.ts      # GitHub OAuth 策略
└── usecases/                       # 用例（CQRS 模式）
    ├── login/
    ├── register/
    ├── password-reset/
    ├── switch-organization/
    └── switch-environment/
```

### 1.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                         AuthModule                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                     Controllers                              │  │
│   │   AuthController, WebhookController, etc.                   │  │
│   └─────────────────────────┬───────────────────────────────────┘  │
│                             │                                        │
│   ┌─────────────────────────▼───────────────────────────────────┐  │
│   │                     Guards                                   │  │
│   │   CommunityUserAuthGuard, PermissionsGuard                  │  │
│   └─────────────────────────┬───────────────────────────────────┘  │
│                             │                                        │
│   ┌─────────────────────────▼───────────────────────────────────┐  │
│   │                   Strategies                                 │  │
│   │   JwtStrategy, ApiKeyStrategy, GitHubStrategy               │  │
│   └─────────────────────────┬───────────────────────────────────┘  │
│                             │                                        │
│   ┌─────────────────────────▼───────────────────────────────────┐  │
│   │                    Services                                  │  │
│   │   AuthService, InMemoryLRUCacheService                      │  │
│   └─────────────────────────┬───────────────────────────────────┘  │
│                             │                                        │
│   ┌─────────────────────────▼───────────────────────────────────┐  │
│   │                   Repositories                               │  │
│   │   UserRepository, MemberRepository, EnvironmentRepository   │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、支持的认证方式

### 2.1 认证方式列表

| 认证方式 | 策略名称 | 适用场景 | 版本 |
|:---|:---|:---|:---|
| **JWT Bearer** | `jwt` | Dashboard 用户登录 | 社区版/企业版 |
| **API Key** | `headerapikey` | 外部 API 调用 | 社区版/企业版 |
| **订阅者 JWT** | `subscriberJwt` | Widget/Inbox 访问 | 社区版/企业版 |
| **GitHub OAuth** | `github` | GitHub 登录 | 社区版 |
| **Clerk JWT** | `jwt-clerk` | 企业版 SSO | 企业版 |
| **Better Auth JWT** | `jwt-better-auth` | 企业版自托管 | 企业版 |
| **Keyless** | `keyless` | 无认证模式 | 企业版 |

### 2.2 认证方式选择逻辑

```typescript
// CommunityUserAuthGuard 根据请求头选择认证策略
@Injectable()
export class CommunityUserAuthGuard extends AuthGuard([
  PassportStrategyEnum.JWT,
  PassportStrategyEnum.HEADER_API_KEY
]) {
  getAuthenticateOptions(context: ExecutionContext): IAuthModuleOptions<any> {
    const request = context.switchToHttp().getRequest();
    const authorizationHeader = request.headers.authorization;
    const authScheme = authorizationHeader?.split(' ')[0];
    
    switch (authScheme) {
      case ApiAuthSchemeEnum.BEARER:
        return { defaultStrategy: PassportStrategyEnum.JWT };
      case ApiAuthSchemeEnum.API_KEY:
        return { defaultStrategy: PassportStrategyEnum.HEADER_API_KEY };
      default:
        throw new UnauthorizedException('Missing authorization header');
    }
  }
}
```

---

## 三、认证流程总览

### 3.1 请求处理流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           认证请求处理流程                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐                                                            │
│  │   客户端    │  Authorization: Bearer xxx / ApiKey xxx                    │
│  └──────┬──────┘                                                            │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────┐                                            │
│  │   CommunityUserAuthGuard    │                                            │
│  │                             │                                            │
│  │  1. 解析 Authorization Header│                                            │
│  │  2. 确定认证方案             │                                            │
│  │  3. 选择对应 Strategy        │                                            │
│  └──────────────┬──────────────┘                                            │
│                 │                                                            │
│         ┌───────┴───────┐                                                    │
│         │               │                                                    │
│    Bearer ▼          ApiKey ▼                                                │
│  ┌──────────────┐  ┌──────────────┐                                          │
│  │ JwtStrategy  │  │ApiKeyStrategy│                                          │
│  │              │  │              │                                          │
│  │ 1.验证Token  │  │ 1.计算哈希   │                                          │
│  │ 2.解析Claims │  │ 2.查询缓存   │                                          │
│  │ 3.加载用户   │  │ 3.查询DB     │                                          │
│  │ 4.加载权限   │  │ 4.加载环境   │                                          │
│  └──────┬───────┘  └──────┬───────┘                                          │
│         │                 │                                                  │
│         └────────┬────────┘                                                  │
│                  │                                                            │
│                  ▼                                                            │
│  ┌─────────────────────────────┐                                             │
│  │      UserSessionData        │                                             │
│  │                             │                                             │
│  │  _id: string                │                                             │
│  │  organizationId: string     │                                             │
│  │  environmentId: string      │                                             │
│  │  roles: MemberRoleEnum[]    │                                             │
│  │  permissions: Permissions[] │                                             │
│  │  scheme: ApiAuthSchemeEnum  │                                             │
│  └──────────────┬──────────────┘                                             │
│                 │                                                            │
│                 ▼                                                            │
│  ┌─────────────────────────────┐                                             │
│  │      注入到 Request.user    │                                             │
│  └─────────────────────────────┘                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Guard 与 Strategy 协作

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Guard 与 Strategy 协作                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   HTTP Request                                                       │
│       │                                                              │
│       ▼                                                              │
│   ┌───────────────────────────────────────────────────────────┐     │
│   │              CommunityUserAuthGuard                        │     │
│   │                                                           │     │
│   │   canActive(context) {                                    │     │
│   │     const authScheme = parseAuthScheme(request);          │     │
│   │     const options = getAuthenticateOptions(context);      │     │
│   │     return super.canActivate(context);  // 调用父类       │     │
│   │   }                                                       │     │
│   └───────────────────────────┬───────────────────────────────┘     │
│                               │                                      │
│                               ▼                                      │
│   ┌───────────────────────────────────────────────────────────┐     │
│   │              PassportAuthGuard (父类)                     │     │
│   │                                                           │     │
│   │   1. 调用 Strategy.authenticate()                         │     │
│   │   2. Strategy.validate() 返回用户信息                     │     │
│   │   3. 将用户信息注入 request.user                          │     │
│   │   4. 返回 true/false                                      │     │
│   └───────────────────────────┬───────────────────────────────┘     │
│                               │                                      │
│                               ▼                                      │
│   ┌───────────────────────────────────────────────────────────┐     │
│   │              JwtStrategy / ApiKeyStrategy                  │     │
│   │                                                           │     │
│   │   validate(request, payload/key) {                        │     │
│   │     // 验证凭证                                           │     │
│   │     // 加载用户信息                                       │     │
│   │     // 返回 UserSessionData                               │     │
│   │   }                                                       │     │
│   └───────────────────────────────────────────────────────────┘     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、模块动态加载机制

### 4.1 社区版与企业版切换

```typescript
// apps/api/src/app/auth/auth.module.ts

function getModuleConfig(): ModuleMetadata {
  if (isClerkEnabled() || isBetterAuthEnabled()) {
    return getEEModuleConfig();  // 企业版配置
  } else {
    return getCommunityAuthModuleConfig();  // 社区版配置
  }
}

@Global()
@Module(getModuleConfig())
export class AuthModule {
  public configure(consumer: MiddlewareConsumer) {
    if (isClerkEnabled() || isBetterAuthEnabled()) {
      configureEE(consumer);
    } else {
      configureCommunity(consumer);
    }
  }
}
```

### 4.2 社区版配置

```typescript
// apps/api/src/app/auth/community.auth.module.config.ts

export function getCommunityAuthModuleConfig(): ModuleMetadata {
  return {
    imports: [
      PassportModule.register({ session: false }),
      JwtModule.register({}),
    ],
    controllers: [AuthController],
    providers: [
      // 策略
      JwtStrategy,
      ApiKeyStrategy,
      JwtSubscriberStrategy,
      GitHubStrategy,
      
      // 服务
      AuthService,
      CommunityAuthService,
      cacheService,
      featureFlagsService,
      InMemoryLRUCacheService,
      
      // 守卫
      CommunityUserAuthGuard,
      RootEnvironmentGuard,
    ],
    exports: [
      AuthService,
      CommunityAuthService,
      CommunityUserAuthGuard,
      RootEnvironmentGuard,
    ],
  };
}
```

### 4.3 企业版配置

```typescript
// apps/api/src/app/auth/ee.auth.module.config.ts

export function getEEModuleConfig(): ModuleMetadata {
  const eeAuthPackage = require('@novu/ee-auth');
  const eeAuthModule = eeAuthPackage?.eeAuthModule;

  if (!eeAuthModule) {
    throw new PlatformException('ee-auth module is not loaded');
  }

  return {
    imports: [...eeAuthModule.imports],
    controllers: [...eeAuthModule.controllers],
    providers: [
      ...eeAuthModule.providers,
      // 复用的服务
      ApiKeyStrategy,
      JwtSubscriberStrategy,
      AuthService,
      cacheService,
      featureFlagsService,
      InMemoryLRUCacheService,
      RootEnvironmentGuard,
    ],
    exports: [
      ...eeAuthModule.exports,
      RootEnvironmentGuard,
      AuthService
    ],
  };
}
```

---

## 五、UserSessionData 类型

### 5.1 类型定义

```typescript
// packages/shared/src/types/auth.ts

export type UserSessionData = {
  // 用户基本信息
  _id: string;
  firstName?: string;
  lastName?: string;
  email?: string;
  profilePicture?: string;
  
  // 租户信息（核心）
  organizationId: string;              // 当前组织 ID
  environmentId: string;               // 当前环境 ID
  
  // 权限信息
  roles: MemberRoleEnum[];             // 角色列表
  permissions: PermissionsEnum[];      // 权限列表
  
  // 认证方案
  scheme: ApiAuthSchemeEnum;           // Bearer / ApiKey / Keyless
};

// 认证方案枚举
export enum ApiAuthSchemeEnum {
  BEARER = 'Bearer',
  API_KEY = 'ApiKey',
  KEYLESS = 'Keyless',
}
```

### 5.2 会话装饰器

```typescript
// libs/application-generic/src/decorators/user-session.decorator.ts

export const UserSession = createParamDecorator((data, ctx) => {
  let req;
  
  // 支持 HTTP 和 GraphQL 两种上下文
  if (ctx.getType() === 'graphql') {
    req = ctx.getArgs()[2].req;
  } else {
    req = ctx.switchToHttp().getRequest();
  }

  if (req.user) {
    return req.user;
  }

  Logger.error(
    'Attempted to access user session without a user in the request. ' +
    'You probably forgot to add the AuthGuard',
    'UserSession'
  );
  throw new InternalServerErrorException();
});
```

### 5.3 Controller 使用示例

```typescript
@Controller('workflows')
export class WorkflowController {
  @Post()
  @RequireAuthentication()
  async create(
    @UserSession() user: UserSessionData,  // 自动注入
    @Body() dto: CreateWorkflowDto
  ) {
    return this.createWorkflow.execute({
      userId: user._id,
      organizationId: user.organizationId,
      environmentId: user.environmentId,
      ...dto,
    });
  }
}
```

---

## 六、认证相关装饰器

### 6.1 @RequireAuthentication

```typescript
// libs/application-generic/src/decorators/auth.decorator.ts

export const RequireAuthentication = () => {
  return applyDecorators(
    UseGuards(CommunityUserAuthGuard),
    ApiBearerAuth()
  );
};

// 使用示例
@Get('/profile')
@RequireAuthentication()
getProfile(@UserSession() user: UserSessionData) {
  return user;
}
```

### 6.2 @ExternalApiAccessible

```typescript
// apps/api/src/app/auth/framework/external-api.decorator.ts

export const ExternalApiAccessible = () => {
  return SetMetadata(IS_EXTERNAL_API_ACCESSIBLE, true);
};

// 使用示例：标记可从外部访问的 API
@Post('/trigger')
@ExternalApiAccessible()
triggerEvent(@Body() dto: TriggerEventDto) {
  // 可通过 API Key 访问
}
```

### 6.3 @RequirePermissions

```typescript
// libs/application-generic/src/decorators/permissions.decorator.ts

export const RequirePermissions = (...permissions: PermissionsEnum[]) => {
  return applyDecorators(
    SetMetadata(PERMISSIONS_KEY, permissions),
    UseGuards(PermissionsGuard),
  );
};

// 使用示例
@Post('/workflows')
@RequireAuthentication()
@RequirePermissions(PermissionsEnum.WORKFLOW_WRITE)
createWorkflow(@Body() dto: CreateWorkflowDto) {
  // 需要 workflow:write 权限
}
```

---

## 七、环境变量配置

| 变量名 | 说明 | 默认值 |
|:---|:---|:---|
| `JWT_SECRET` | JWT 签名密钥 | - |
| `GITHUB_OAUTH_CLIENT_ID` | GitHub OAuth 客户端 ID | - |
| `GITHUB_OAUTH_CLIENT_SECRET` | GitHub OAuth 客户端密钥 | - |
| `NOVU_ENTERPRISE` | 启用企业版 | `false` |
| `EE_AUTH_PROVIDER` | 企业版认证提供者 | `clerk` |
| `FRONT_BASE_URL` | 前端基础 URL | - |
| `API_ROOT_URL` | API 基础 URL | - |
| `DISABLE_USER_REGISTRATION` | 禁用用户注册 | `false` |
| `SUBSCRIBER_WIDGET_JWT_EXPIRATION_TIME` | 订阅者 Token 过期时间 | `15 days` |

---

*文档版本：1.0*  
*更新时间：2026-02-22*
