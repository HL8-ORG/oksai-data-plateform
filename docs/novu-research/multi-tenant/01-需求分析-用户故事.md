# Novu 多租户技术方案 - 需求分析（用户故事）

## 一、业务背景

### 1.1 产品定位

Novu 是一个 **B2B SaaS 通知基础设施平台**，服务于以下客户群体：

| 客户类型 | 描述 | 典型需求 |
|:---|:---|:---|
| **ISV 独立软件开发商** | 将 Novu 嵌入自己的产品中 | 多环境管理、白标定制 |
| **SaaS 平台** | 为自己的终端客户提供通知服务 | 终端租户隔离、自定义品牌 |
| **企业客户** | 内部系统通知需求 | 组织架构、权限管理 |

### 1.2 多租户需求层次

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Novu 多租户需求层次                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Level 1: 组织隔离                                                   │
│  ├── 独立的计费账户                                                  │
│  ├── 独立的品牌配置                                                  │
│  ├── 独立的成员管理                                                  │
│  └── 独立的数据边界                                                  │
│                                                                      │
│  Level 2: 环境隔离                                                   │
│  ├── 开发/生产环境分离                                               │
│  ├── 独立的 API Key                                                  │
│  ├── 独立的集成配置                                                  │
│  └── 独立的工作流定义                                                │
│                                                                      │
│  Level 3: 终端租户隔离                                               │
│  ├── SaaS 平台的终端客户                                             │
│  ├── 消息上下文隔离                                                  │
│  └── 订阅者数据隔离                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、用户角色定义

### 2.1 角色列表

| 角色 | 描述 | 典型职责 |
|:---|:---|:---|
| **组织所有者 (Owner)** | 组织创建者 | 计费管理、组织设置、所有权限 |
| **组织管理员 (Admin)** | 组织管理层 | 成员管理、配置管理、无计费权限 |
| **开发者 (Author)** | 技术团队 | 工作流开发、集成配置、事件触发 |
| **只读用户 (Viewer)** | 业务团队 | 数据查看、报表查看 |
| **API 调用方** | 外部系统 | 通过 API Key 访问 |

### 2.2 角色关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Organization                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐          │
│   │   Owner     │     │    Admin    │     │   Author    │          │
│   │             │     │             │     │             │          │
│   │ • 计费管理   │     │ • 成员管理   │     │ • 工作流开发 │          │
│   │ • 组织设置   │     │ • 集成配置   │     │ • 事件触发   │          │
│   │ • 所有权限   │     │ • 大部分权限  │     │ • 部分权限   │          │
│   └─────────────┘     └─────────────┘     └─────────────┘          │
│                                                                      │
│   ┌─────────────┐     ┌─────────────┐                               │
│   │   Viewer    │     │  API Client │                               │
│   │             │     │             │                               │
│   │ • 数据查看   │     │ • API Key   │                               │
│   │ • 只读权限   │     │ • 全权限    │                               │
│   └─────────────┘     └─────────────┘                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、用户故事（User Stories）

### 3.1 组织管理（Organization）

#### US-ORG-001: 创建组织

```
作为 新用户
我希望 创建一个组织
以便于 开始使用 Novu 服务

验收标准：
✓ 组织名称必填，最多 100 字符
✓ 自动创建 Production 和 Development 两个环境
✓ 创建者自动成为组织 Owner
✓ 生成默认的 API Key
✓ 支持设置组织品牌颜色和 Logo
```

#### US-ORG-002: 组织成员管理

```
作为 组织管理员
我希望 邀请成员加入组织
以便于 团队协作

验收标准：
✓ 通过邮箱邀请成员
✓ 可指定成员角色（Admin/Author/Viewer）
✓ 邀请链接 7 天有效期
✓ 被邀请人收到邮件通知
✓ 成员接受邀请后自动获得相应权限
```

#### US-ORG-003: 跨组织切换

```
作为 属于多个组织的用户
我希望 在不同组织之间切换
以便于 管理不同客户的项目

验收标准：
✓ 显示用户所属的所有组织列表
✓ 一键切换当前组织
✓ 切换后刷新所有数据（工作流、集成等）
✓ 切换后生成新的 JWT Token
✓ 保持当前环境选择（开发/生产）
```

### 3.2 环境管理（Environment）

#### US-ENV-001: 环境隔离

```
作为 开发者
我希望 有独立的开发和生产环境
以便于 安全地测试而不影响生产数据

验收标准：
✓ 每个组织默认有 Development 和 Production 环境
✓ 环境间数据完全隔离（工作流、订阅者、消息）
✓ 每个环境有独立的 API Key
✓ 环境间可复制工作流配置
✓ 环境有独立的集成配置
```

#### US-ENV-002: API Key 管理

```
作为 组织管理员
我希望 管理环境的 API Key
以便于 安全地控制 API 访问

验收标准：
✓ 可创建多个 API Key
✓ 可为 API Key 设置描述和过期时间
✓ 可撤销/删除 API Key
✓ API Key 存储时加密
✓ 记录 API Key 的使用日志
```

#### US-ENV-003: 环境变量配置

```
作为 开发者
我希望 为不同环境配置不同的参数
以便于 适配开发/测试/生产环境

验收标准：
✓ 支持 Bridge URL 配置（自定义工作流执行端点）
✓ 支持 Echo URL 配置（自定义回调端点）
✓ 支持 DNS 配置（邮件发送域名）
✓ 支持 API 速率限制配置
✓ 环境配置变更实时生效
```

### 3.3 终端租户管理（Tenant）

#### US-TENANT-001: 创建终端租户

```
作为 SaaS 平台开发者
我希望 为我的每个客户创建独立的租户
以便于 实现客户间的数据隔离

验收标准：
✓ 支持通过 API 创建租户
✓ 租户标识符（identifier）在环境内唯一
✓ 可存储租户自定义数据（JSON）
✓ 租户数据与订阅者关联
✓ 支持按租户过滤消息和订阅者
```

#### US-TENANT-002: 租户上下文隔离

```
作为 SaaS 平台开发者
我希望 同一环境内的不同租户数据互不可见
以便于 保护客户数据隐私

验收标准：
✓ Inbox 消息按租户隔离
✓ 订阅者数据按租户隔离
✓ 工作流执行时可指定租户上下文
✓ WebSocket 推送按租户隔离
✓ 租户间数据查询性能不受影响
```

### 3.4 权限管理（RBAC）

#### US-PERM-001: 细粒度权限控制

```
作为 组织管理员
我希望 精细控制成员的访问权限
以便于 满足企业安全合规要求

验收标准：
✓ 预定义角色：Owner/Admin/Author/Viewer
✓ 权限按资源类型划分：工作流、集成、订阅者、消息
✓ 权限按操作类型划分：读、写、删除
✓ 支持查看成员当前权限
✓ Business 层级强制权限检查
```

#### US-PERM-002: API Key 权限

```
作为 外部系统
我希望 通过 API Key 访问 Novu
以便于 集成到我的应用中

验收标准：
✓ API Key 拥有环境的完整访问权限
✓ API Key 可访问所属环境的所有资源
✓ API Key 不能访问其他环境的数据
✓ API Key 认证跳过 RBAC 权限检查
✓ 支持 API Key 过期和撤销
```

### 3.5 数据隔离

#### US-DATA-001: 查询自动过滤

```
作为 系统架构师
我希望 所有数据查询自动包含租户过滤
以便于 防止数据泄露

验收标准：
✓ 所有 Repository 查询必须包含组织/环境 ID
✓ 编译时类型检查，缺少过滤条件编译失败
✓ 运行时验证，缺少过滤条件抛出异常
✓ 支持查询审计日志
✓ 跨租户查询必须显式声明
```

#### US-DATA-002: 消息历史隔离

```
作为 组织成员
我希望 只能看到本组织的消息历史
以便于 保护数据隐私

验收标准：
✓ Dashboard 消息列表按组织过滤
✓ API 消息查询按环境过滤
✓ 消息导出仅包含本组织数据
✓ 消息搜索不跨组织
✓ 统计报表按组织聚合
```

---

## 四、非功能性需求

### 4.1 安全需求

| 需求 | 描述 | 验收标准 |
|:---|:---|:---|
| **数据隔离** | 租户间数据完全隔离 | 无跨租户数据访问案例 |
| **认证安全** | JWT + API Key 双模式 | Token 2 小时过期 |
| **传输加密** | 全站 HTTPS | TLS 1.2+ |
| **存储加密** | 敏感数据加密存储 | AES-256 |
| **审计日志** | 关键操作记录 | 保留 90 天 |

### 4.2 性能需求

| 需求 | 描述 | 验收标准 |
|:---|:---|:---|
| **查询性能** | 租户过滤不影响性能 | 增加 <10ms |
| **并发能力** | 支持多租户并发访问 | 10000 QPS |
| **数据扩展** | 支持大量租户数据 | 单表 10 亿行 |
| **响应时间** | API 响应时间 | P99 < 200ms |

### 4.3 可用性需求

| 需求 | 描述 | 验收标准 |
|:---|:---|:---|
| **服务可用性** | 系统正常运行时间 | 99.9% |
| **数据备份** | 定期数据备份 | 每日备份 |
| **灾难恢复** | 快速恢复能力 | RTO < 4h |
| **故障隔离** | 租户故障不扩散 | 单租户影响 |

---

## 五、约束条件

### 5.1 技术约束

- 使用 MongoDB 作为主数据库
- 使用 Redis 作为缓存和队列
- 使用 NestJS 框架
- 使用 TypeScript 语言

### 5.2 业务约束

- 免费层不支持细粒度权限控制
- 终端租户数量与环境类型相关
- API Key 数量有限制
- 消息保留时间有限制

---

## 六、需求优先级

### 6.1 P0 - 核心需求（必须有）

- [x] 组织隔离
- [x] 环境隔离
- [x] 数据自动过滤
- [x] 基础角色管理
- [x] API Key 认证

### 6.2 P1 - 重要需求（应该有）

- [x] 细粒度权限控制
- [x] 终端租户隔离
- [x] contextKeys 上下文
- [x] 跨组织切换
- [x] 审计日志

### 6.3 P2 - 次要需求（可以有）

- [ ] 自定义角色
- [ ] 权限模板
- [ ] 数据掩码
- [ ] 租户配额
- [ ] 多区域部署

---

*文档版本：1.0*  
*更新时间：2026-02-22*
