# Novu 多租户技术方案 - 功能与机制

## 一、三层租户模型

### 1.1 架构概览

Novu 采用 **Organization → Environment → Tenant** 三层架构：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              多租户架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │                      Organization (组织层)                           │  │
│    │                                                                      │  │
│    │   职责：计费、品牌、全局配置、成员管理                                 │  │
│    │   隔离：完全独立的数据边界                                            │  │
│    │   标识：_organizationId                                              │  │
│    │                                                                      │  │
│    │   ┌───────────────────────────┐   ┌───────────────────────────┐    │  │
│    │   │   Environment (环境层)    │   │   Environment (环境层)    │    │  │
│    │   │                          │   │                          │    │  │
│    │   │   职责：API Key、集成配置  │   │   职责：API Key、集成配置  │    │  │
│    │   │   隔离：开发/生产数据分离  │   │   隔离：开发/生产数据分离  │    │  │
│    │   │   标识：_environmentId    │   │   标识：_environmentId    │    │  │
│    │   │                          │   │                          │    │  │
│    │   │   ┌─────┐ ┌─────┐ ┌─────┐│   │   ┌─────┐ ┌─────┐ ┌─────┐│    │  │
│    │   │   │Tenant│ │Tenant│ │Tenant││   │   │Tenant│ │Tenant│ │Tenant││    │  │
│    │   │   │(租户)│ │(租户)│ │(租户)││   │   │(租户)│ │(租户)│ │(租户)││    │  │
│    │   │   └─────┘ └─────┘ └─────┘│   │   └─────┘ └─────┘ └─────┘│    │  │
│    │   │                          │   │                          │    │  │
│    │   │   标识：contextKeys[]    │   │   标识：contextKeys[]    │    │  │
│    │   └───────────────────────────┘   └───────────────────────────┘    │  │
│    │                                                                      │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 各层职责

| 层级 | 职责 | 隔离粒度 | 存储字段 |
|:---|:---|:---|:---|
| **Organization** | 计费、品牌、全局配置 | 完全独立 | `_organizationId` |
| **Environment** | API Key、集成配置、工作流 | 环境隔离 | `_environmentId` |
| **Tenant** | 终端租户上下文 | 消息级别 | `contextKeys[]` |

---

## 二、实体设计

### 2.1 Organization 实体

```typescript
// 文件位置: libs/dal/src/repositories/organization/organization.entity.ts

export class OrganizationEntity {
  _id: string;
  
  // 基础信息
  name: string;                          // 组织名称
  logo?: string;                         // Logo URL
  
  // 服务等级
  apiServiceLevel: ApiServiceLevelEnum;  // FREE/PRO/BUSINESS/ENTERPRISE
  isTrial?: boolean;                     // 是否试用
  
  // 品牌配置
  branding?: {
    fontColor?: string;
    contentBackground?: string;
    fontFamily?: string;
    logo?: string;
    color?: string;
    direction?: 'ltr' | 'rtl';
  };
  
  // 多语言
  defaultLocale?: string;                // 默认语言
  targetLocales?: string[];              // 目标语言列表
  
  // 计费
  stripeCustomerId?: string;             // Stripe 客户 ID
  externalId?: string;                   // 外部系统 ID
  
  // 功能开关
  productUseCases?: {
    delay?: boolean;
    digest?: boolean;
    translation?: boolean;
    multi_channel?: boolean;
    in_app?: boolean;
  };
}
```

**服务等级差异：**

| 等级 | 权限检查 | 终端租户 | API 限制 |
|:---|:---|:---|:---|
| FREE | 跳过 | 不支持 | 低 |
| PRO | 跳过 | 不支持 | 中 |
| BUSINESS | 强制 | 支持 | 高 |
| ENTERPRISE | 强制 | 支持 | 无限制 |

### 2.2 Environment 实体

```typescript
// 文件位置: libs/dal/src/repositories/environment/environment.entity.ts

export class EnvironmentEntity {
  _id: string;
  
  // 基础信息
  name: string;                          // Development / Production
  identifier: string;                    // 环境唯一标识符
  
  // 多租户关联
  _organizationId: string;               // 所属组织
  _parentId?: string;                    // 父环境 ID（开发环境指向生产）
  
  // 环境类型
  type: EnvironmentTypeEnum;             // PRODUCTION / DEVELOPMENT
  
  // API Key 管理
  apiKeys: IApiKey[];
  
  // API 速率限制
  apiRateLimits?: {
    [ApiRateLimitCategoryEnum.TRIGGER]?: number;
    [ApiRateLimitCategoryEnum.CONFIGURATION]?: number;
    [ApiRateLimitCategoryEnum.GLOBAL]?: number;
  };
  
  // DNS 配置
  dns?: {
    mxRecordConfigured?: boolean;
    inboundParseDomain?: string;
  };
  
  // 服务 URL
  bridge?: { url: string };              // Bridge 服务 URL
  echo?: { url: string };                // Echo 服务 URL
  webhookAppId?: string;                 // Webhook 应用 ID
}

// API Key 结构
interface IApiKey {
  key: EncryptedSecret | string;         // 加密的 API Key
  hash?: string;                         // SHA256 哈希（用于查询）
  _userId: string;                       // 创建者 ID
}
```

### 2.3 Tenant 实体

```typescript
// 文件位置: libs/dal/src/repositories/tenant/tenant.entity.ts

export class TenantEntity {
  _id: string;
  
  // 租户标识
  identifier: string;                    // 租户唯一标识符（环境内唯一）
  
  // 基础信息
  name?: string;                         // 租户名称
  
  // 自定义数据
  data?: Record<string, unknown>;        // 租户自定义数据（JSON）
  
  // 多租户关联
  _environmentId: string;                // 所属环境
  _organizationId: string;               // 所属组织
}
```

### 2.4 Member 实体

```typescript
// 文件位置: libs/dal/src/repositories/member/member.entity.ts

export class MemberEntity {
  _id: string;
  
  // 关联
  _userId: string;                       // 用户 ID
  _organizationId: string;               // 组织 ID
  
  // 角色
  roles: MemberRoleEnum[];               // 角色列表
  
  // 状态
  memberStatus: MemberStatusEnum;        // INVITED / ACTIVE
  
  // 邀请信息
  invite?: {
    email: string;
    token: string;
    invitationDate: Date;
    answerDate?: Date;
    _inviterId: string;
  };
}
```

---

## 三、数据隔离机制

### 3.1 数据库层隔离策略

**采用：共享数据库 + 行级隔离**

```
┌─────────────────────────────────────────────────────────────────────┐
│                      MongoDB 数据库                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  notificationtemplates 集合                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ {                                                            │   │
│  │   _id: ObjectId("..."),                                      │   │
│  │   name: "Welcome Email",                                     │   │
│  │   _organizationId: ObjectId("org-1"),  ◄── 组织隔离          │   │
│  │   _environmentId: ObjectId("env-1"),   ◄── 环境隔离          │   │
│  │   ...                                                        │   │
│  │ }                                                            │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ { _organizationId: ObjectId("org-1"), _environmentId: ... } │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ { _organizationId: ObjectId("org-2"), _environmentId: ... } │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  messages 集合                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ {                                                            │   │
│  │   _id: ObjectId("..."),                                      │   │
│  │   _organizationId: ObjectId("org-1"),                        │   │
│  │   _environmentId: ObjectId("env-1"),                         │   │
│  │   contextKeys: ["tenant-a", "region-us"], ◄── 终端租户隔离   │   │
│  │   ...                                                        │   │
│  │ }                                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 泛型约束实现

**类型定义：**

```typescript
// 文件位置: libs/dal/src/types/enforce.ts

// 强制约束类型
export type EnforceOrgId = { _organizationId: OrganizationId };
export type EnforceEnvId = { _environmentId: EnvironmentId };
export type EnforceEnvOrOrgIds = EnforceEnvId | EnforceOrgId;
```

**BaseRepository 泛型实现：**

```typescript
// 文件位置: libs/dal/src/repositories/base-repository.ts

export class BaseRepository<T_DBModel, T_MappedEntity, T_Enforcement> {
  
  /**
   * 所有查询方法都强制带上 T_Enforcement 约束
   * TypeScript 编译时会检查，如果调用时缺少约束字段，编译失败
   */
  
  async findOne(
    query: FilterQuery<T_DBModel> & T_Enforcement,
    select?: ProjectionType<T_MappedEntity>,
    options?: { readPreference?: 'primary' | 'secondaryPreferred'; session?: ClientSession }
  ): Promise<T_MappedEntity | null> {
    const item = await this.MongooseModel.findOne(query, select, options).lean();
    return item ? this.mapEntity(item) : null;
  }

  async find(
    query: FilterQuery<T_DBModel> & T_Enforcement,
    select: ProjectionType<T_MappedEntity> = '',
    options?: { 
      limit?: number; 
      skip?: number; 
      sort?: Record<string, SortOrder>;
      readPreference?: 'primary' | 'secondaryPreferred';
    }
  ): Promise<T_MappedEntity[]> {
    let queryBuilder = this.MongooseModel.find(query, select, options);
    
    if (options?.limit) queryBuilder = queryBuilder.limit(options.limit);
    if (options?.skip) queryBuilder = queryBuilder.skip(options.skip);
    if (options?.sort) queryBuilder = queryBuilder.sort(options.sort);
    
    const items = await queryBuilder.lean();
    return this.mapEntities(items);
  }

  async update(
    query: FilterQuery<T_DBModel> & T_Enforcement,
    updateBody: UpdateQuery<T_DBModel>,
    options?: { session?: ClientSession }
  ): Promise<{ matched: number; modified: number }> {
    const result = await this.MongooseModel.updateMany(query, updateBody, options);
    return { matched: result.matchedCount, modified: result.modifiedCount };
  }

  async delete(
    query: FilterQuery<T_DBModel> & T_Enforcement,
    options?: { session?: ClientSession }
  ): Promise<{ acknowledged: boolean; deletedCount: number }> {
    const result = await this.MongooseModel.deleteMany(query, options);
    return { acknowledged: result.acknowledged, deletedCount: result.deletedCount };
  }
}
```

**Repository 实现示例：**

```typescript
// MessageRepository 强制环境 ID 约束
export class MessageRepository extends BaseRepository<
  MessageDBModel,
  MessageEntity,
  EnforceEnvId  // ★ 所有操作必须带 _environmentId
> {
  async findBySubscriber(environmentId: string, subscriberId: string) {
    // 编译时检查：必须包含 _environmentId
    return this.find({
      _environmentId: environmentId,  // ★ 如果缺少，TypeScript 编译失败
      _subscriberId: subscriberId,
    });
  }
}

// MemberRepository 强制组织 ID 约束
export class MemberRepository extends BaseRepository<
  MemberDBModel,
  MemberEntity,
  EnforceOrgId  // ★ 所有操作必须带 _organizationId
> {
  async findByOrg(organizationId: string) {
    return this.find({
      _organizationId: organizationId,  // ★ 强制包含
    });
  }
}
```

### 3.3 contextKeys 上下文隔离

**用途：** 在同一 Environment 内实现更细粒度的数据隔离

**Message Schema：**

```typescript
// message.schema.ts
const messageSchema = new Schema({
  // ... 其他字段
  contextKeys: {
    type: [Schema.Types.String],
    default: undefined,
  },
});

// 复合索引支持 contextKeys 查询
messageSchema.index({
  _subscriberId: 1,
  _environmentId: 1,
  channel: 1,
  contextKeys: 1,
  seen: 1,
  read: 1,
  createdAt: -1,
});
```

**查询构建器：**

```typescript
// base-repository.ts

/**
 * 构建 contextKeys 精确匹配查询
 * 
 * @param contextKeys - 上下文键数组
 * @param options - 配置选项
 * @returns MongoDB 查询条件
 */
public buildContextExactMatchQuery(
  contextKeys?: string[],
  options?: {
    enabled?: boolean;
    strictEmpty?: boolean;
  }
): Record<string, unknown> {
  const { enabled = true, strictEmpty = false } = options ?? {};

  if (!enabled) return {};

  // 空上下文：匹配默认/全局数据
  if (contextKeys === undefined || contextKeys.length === 0) {
    if (strictEmpty) {
      return { contextKeys: [] };
    }
    // 兼容旧数据：字段不存在或为空数组
    return {
      $or: [
        { contextKeys: { $exists: false } },
        { contextKeys: [] }
      ],
    };
  }

  // 非空上下文：精确匹配（顺序无关）
  const sortedKeys = [...contextKeys].sort();
  return {
    contextKeys: { $all: sortedKeys, $size: sortedKeys.length },
  };
}
```

**使用示例：**

```typescript
// message.repository.ts

async getInboxMessages(
  environmentId: string,
  subscriberId: string,
  contextKeys?: string[]
) {
  // 基础查询条件
  const query: FilterQuery<MessageDBModel> & EnforceEnvId = {
    _environmentId: environmentId,
    _subscriberId: subscriberId,
  };

  // 应用 contextKeys 过滤
  const contextQuery = this.buildContextExactMatchQuery(contextKeys);
  if (Object.keys(contextQuery).length > 0) {
    query.$and = [contextQuery];
  }

  return this.find(query, '', { sort: { createdAt: -1 } });
}
```

---

## 四、认证与授权机制

### 4.1 双认证模式

```
┌─────────────────────────────────────────────────────────────────────┐
│                        双认证模式                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    Dashboard 用户                            │  │
│   │                                                              │  │
│   │   认证方式：JWT (Bearer Token)                               │  │
│   │   权限检查：RBAC (根据角色和权限)                             │  │
│   │   租户解析：JWT Claims 中的 organizationId                   │  │
│   │                                                              │  │
│   │   Authorization: Bearer eyJhbGciOiJIUzI1NiIs...              │  │
│   │                                                              │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                    API 调用方                                │  │
│   │                                                              │  │
│   │   认证方式：API Key                                          │  │
│   │   权限检查：跳过 (API Key 拥有环境完整权限)                   │  │
│   │   租户解析：API Key 关联的 environmentId                     │  │
│   │                                                              │  │
│   │   Authorization: ApiKey sk_live_xxxxxxxxxxxx                 │  │
│   │                                                              │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 JWT 认证流程

```typescript
// 文件位置: apps/api/src/app/auth/services/passport/jwt.strategy.ts

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(
    private readonly authService: AuthService,
    private environmentRepository: EnvironmentRepository,
  ) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: process.env.JWT_SECRET,
      passReqToCallback: true,
    });
  }

  async validate(req: http.IncomingMessage, session: UserSessionData) {
    // 1. 设置认证方案
    session.scheme = ApiAuthSchemeEnum.BEARER;

    // 2. 验证用户
    const user = await this.authService.validateUser(session);
    if (!user) {
      throw new UnauthorizedException();
    }

    // 3. 从请求头解析 Environment ID
    const environmentId = this.resolveEnvironmentId(req, session);
    session.environmentId = environmentId;

    // 4. 验证 Environment 属于该 Organization
    if (session.environmentId) {
      const environment = await this.environmentRepository.findOne({
        _id: session.environmentId,
        _organizationId: session.organizationId,
      }, '_id');

      if (!environment) {
        throw new UnauthorizedException('Cannot find environment');
      }
    }

    return session;
  }

  resolveEnvironmentId(req: http.IncomingMessage, session: UserSessionData) {
    const headerKey = HttpRequestHeaderKeysEnum.NOVU_ENVIRONMENT_ID.toLowerCase();
    return req.headers[headerKey] as string;
  }
}
```

### 4.3 API Key 认证流程

```typescript
// 文件位置: apps/api/src/app/auth/services/passport/apikey.strategy.ts

@Injectable()
export class ApiKeyStrategy extends PassportStrategy(HeaderAPIKeyStrategy) {
  constructor(
    private readonly authService: AuthService,
    private readonly inMemoryLRUCacheService: InMemoryLRUCacheService,
  ) {
    super(
      { header: 'Authorization', prefix: 'ApiKey ' },
      true,
      async (apikey: string, verified) => {
        try {
          const user = await this.validateApiKey(apikey);
          return verified(null, user || false);
        } catch (err) {
          return verified(err as Error, false);
        }
      }
    );
  }

  private async validateApiKey(apiKey: string): Promise<UserSessionData | null> {
    // 1. 计算 API Key 哈希
    const hashedApiKey = createHash('sha256').update(apiKey).digest('hex');

    // 2. 从缓存或数据库获取用户信息
    return this.inMemoryLRUCacheService.get(
      InMemoryLRUCacheStore.API_KEY_USER,
      hashedApiKey,
      () => this.authService.getUserByApiKey(apiKey),
      { environmentId: 'system' }
    );
  }
}
```

### 4.4 RBAC 权限检查

**权限装饰器：**

```typescript
// 文件位置: libs/application-generic/src/decorators/permissions.decorator.ts

export const PERMISSIONS_KEY = 'permissions';

export const RequirePermissions = (...permissions: PermissionsEnum[]) => {
  return applyDecorators(
    SetMetadata(PERMISSIONS_KEY, permissions),
    UseGuards(PermissionsGuard),
  );
};

export const SkipPermissionsCheck = () => {
  return SetMetadata(NO_PERMISSIONS_KEY, true);
};
```

**Guard 实现：**

```typescript
@Injectable()
export class PermissionsGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private organizationRepository: OrganizationRepository,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    // 1. 检查是否跳过权限检查
    const skipCheck = this.reflector.get<boolean>(NO_PERMISSIONS_KEY, context.getHandler());
    if (skipCheck) return true;

    // 2. 获取所需权限
    const requiredPermissions = this.reflector.get<PermissionsEnum[]>(
      PERMISSIONS_KEY, 
      context.getHandler()
    );
    if (!requiredPermissions?.length) return true;

    // 3. 获取用户会话
    const request = context.switchToHttp().getRequest();
    const user: UserSessionData = request.user;

    // 4. API Key 认证跳过权限检查
    if (user.scheme === ApiAuthSchemeEnum.API_KEY) {
      return true;
    }

    // 5. 检查组织服务等级
    const organization = await this.organizationRepository.findById(user.organizationId);
    
    // Free/Pro 层级跳过权限检查
    if (organization.apiServiceLevel === ApiServiceLevelEnum.FREE ||
        organization.apiServiceLevel === ApiServiceLevelEnum.PRO) {
      return true;
    }

    // 6. Business 层级执行权限检查
    const hasAllPermissions = requiredPermissions.every(
      (perm) => user.permissions.includes(perm)
    );

    if (!hasAllPermissions) {
      throw new ForbiddenException('Insufficient permissions');
    }

    return true;
  }
}
```

---

## 五、请求上下文传递

### 5.1 完整链路

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          请求处理流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. HTTP 请求                                                            │
│     ┌────────────────────────────────────────────────────────────────┐  │
│     │ POST /v1/workflows                                             │  │
│     │ Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                  │  │
│     │ novu-environment-id: env-789                                   │  │
│     └────────────────────────────────────────────────────────────────┘  │
│                                    ▼                                     │
│                                                                          │
│  2. CommunityUserAuthGuard                                               │
│     ├── 解析 Authorization Header                                        │
│     ├── 选择认证策略（Bearer → JWT / ApiKey → API Key）                  │
│     └── 调用对应 Strategy                                                │
│                                    ▼                                     │
│                                                                          │
│  3. JwtStrategy.validate()                                               │
│     ├── 验证 JWT 签名                                                    │
│     ├── 提取 organizationId, roles, permissions                         │
│     ├── 从 Header 解析 environmentId                                     │
│     └── 验证 Environment 属于 Organization                              │
│                                    ▼                                     │
│                                                                          │
│  4. PermissionsGuard                                                     │
│     ├── 检查 @RequirePermissions 装饰器                                  │
│     ├── Free/Pro：跳过检查                                               │
│     └── Business：验证 user.permissions                                  │
│                                    ▼                                     │
│                                                                          │
│  5. Controller                                                           │
│     ┌────────────────────────────────────────────────────────────────┐  │
│     │ @Post('/workflows')                                            │  │
│     │ async create(                                                  │  │
│     │   @UserSession() user: UserSessionData,  // ◄── 注入会话       │  │
│     │   @Body() body: CreateWorkflowDto                              │  │
│     │ ) {                                                            │  │
│     │   return this.createWorkflow.execute(                          │  │
│     │     CreateWorkflowCommand.create({                             │  │
│     │       userId: user._id,                                        │  │
│     │       organizationId: user.organizationId,  // ◄── 传递       │  │
│     │       environmentId: user.environmentId,    // ◄── 传递       │  │
│     │       ...body                                                  │  │
│     │     })                                                         │  │
│     │   );                                                            │  │
│     │ }                                                              │  │
│     └────────────────────────────────────────────────────────────────┘  │
│                                    ▼                                     │
│                                                                          │
│  6. UseCase / Repository                                                 │
│     ┌────────────────────────────────────────────────────────────────┐  │
│     │ const workflow = await this.repository.create({                │  │
│     │   name: command.name,                                          │  │
│     │   _organizationId: command.organizationId,  // ◄── 存储       │  │
│     │   _environmentId: command.environmentId,    // ◄── 存储       │  │
│     │ });                                                            │  │
│     └────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 UserSessionData 类型

```typescript
// 文件位置: packages/shared/src/types/auth.ts

export type UserSessionData = {
  // 用户信息
  _id: string;
  firstName?: string;
  lastName?: string;
  email?: string;
  profilePicture?: string;
  
  // ★ 租户信息（核心）
  organizationId: string;          // 组织 ID
  environmentId: string;           // 环境 ID（从 Header 注入）
  
  // 权限信息
  roles: MemberRoleEnum[];         // 角色列表
  permissions: PermissionsEnum[];  // 权限列表
  
  // 认证方案
  scheme: ApiAuthSchemeEnum;       // BEARER / API_KEY
};
```

### 5.3 跨服务传递

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      跨服务租户传递                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  API Service                                            Worker Service  │
│  ┌────────────────────────┐                            ┌──────────────┐ │
│  │ Controller             │                            │ Job Processor│ │
│  │                        │                            │              │ │
│  │ await queueService.add({                            │ job.data {   │ │
│  │   name: 'send-email',  │                            │   organization│ │
│  │   data: {              │ ───── BullMQ Queue ──────► │   Id,        │ │
│  │     organizationId,    │                            │   environment │ │
│  │     environmentId,     │                            │   Id,        │ │
│  │     userId,            │                            │   userId,    │ │
│  │     payload,           │                            │   payload    │ │
│  │   }                    │                            │ }            │ │
│  │ })                     │                            │              │ │
│  │                        │                            │ ▼            │ │
│  │                        │                            │ Repository   │ │
│  │                        │                            │ .find({      │ │
│  │                        │                            │   _orgId,    │ │
│  │                        │                            │   _envId     │ │
│  │                        │                            │ })           │ │
│  └────────────────────────┘                            └──────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、配置隔离

### 6.1 Integration 配置隔离

```typescript
// Integration Schema
{
  _id: ObjectId,
  _environmentId: ObjectId,    // 环境级别隔离
  _organizationId: ObjectId,   // 组织级别隔离
  
  providerId: String,          // sendgrid, slack, etc.
  channel: String,             // email, sms, push, chat
  
  credentials: {               // 凭证（加密存储）
    apiKey: EncryptedSecret,
    secretKey: EncryptedSecret,
  },
  
  active: Boolean,
  primary: Boolean,
  priority: Number,
  
  conditions: [{               // 条件路由
    type: String,
    value: String,
  }],
}
```

### 6.2 Workflow 配置隔离

```typescript
// NotificationTemplate Schema
{
  _id: ObjectId,
  name: String,
  active: Boolean,
  
  // 多租户字段
  _environmentId: ObjectId,    // 环境隔离
  _organizationId: ObjectId,   // 组织隔离
  
  // 触发器（环境内唯一）
  triggers: [{
    type: String,
    identifier: String,        // 触发器标识符
  }],
  
  // 步骤定义
  steps: [{ ... }],
}

// 索引：环境内触发器唯一
notificationTemplateSchema.index({
  _environmentId: 1,
  'triggers.identifier': 1,
});
```

---

## 七、关键设计总结

| 特性 | 实现方式 | 效果 |
|:---|:---|:---|
| **类型安全** | TypeScript 泛型 `T_Enforcement` | 编译时强制租户约束 |
| **三层隔离** | Organization → Environment → Tenant | 多级隔离粒度 |
| **双认证** | JWT + API Key | 支持用户和系统两种访问模式 |
| **差异化权限** | 按服务等级调整检查策略 | Free/Pro 跳过，Business 强制 |
| **上下文隔离** | contextKeys 数组 | 环境内的细粒度数据隔离 |
| **缓存优化** | API Key LRU 缓存 | 减少数据库查询 |

---

*文档版本：1.0*  
*更新时间：2026-02-22*
