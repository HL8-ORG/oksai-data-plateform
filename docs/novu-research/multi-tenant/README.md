# Novu 多租户技术方案文档索引

本目录包含 Novu 多租户技术方案的详细文档。

## 文档列表

| 文档 | 内容 | 适用读者 |
|:---|:---|:---|
| [01-需求分析-用户故事.md](./01-需求分析-用户故事.md) | 业务需求、用户角色、用户故事、非功能需求 | 产品经理、业务分析师 |
| [02-功能与机制.md](./02-功能与机制.md) | 三层模型、实体设计、数据隔离、认证授权、上下文传递 | 架构师、后端开发者 |
| [03-策略与最佳实践.md](./03-策略与最佳实践.md) | 隔离策略、安全策略、性能优化、可扩展性、设计模式 | 架构师、技术负责人 |

## 核心概念速览

### 三层租户模型

```
Organization（组织层）
    └── Environment（环境层）
            └── Tenant（终端租户层）
```

| 层级 | 隔离字段 | 隔离粒度 |
|:---|:---|:---|
| Organization | `_organizationId` | 完全隔离 |
| Environment | `_environmentId` | 环境隔离 |
| Tenant | `contextKeys[]` | 消息级别 |

### 关键技术点

1. **泛型约束**：`T_Enforcement` 在编译时强制租户过滤
2. **双认证模式**：JWT（用户）+ API Key（系统）
3. **RBAC 权限**：按服务等级差异化权限检查
4. **contextKeys**：环境内的细粒度上下文隔离

### 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          请求处理流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  HTTP Request ──► Auth Guard ──► Strategy ──► Permissions Guard     │
│                        │              │              │               │
│                        ▼              ▼              ▼               │
│                  解析 JWT/API   提取租户信息   检查权限              │
│                                                                      │
│                         └──────────┬───────────────┘                │
│                                    ▼                                 │
│                            Controller                               │
│                         @UserSession()                              │
│                                    │                                 │
│                                    ▼                                 │
│                              UseCase                                │
│                           Command {                                 │
│                             organizationId,                         │
│                             environmentId                           │
│                           }                                         │
│                                    │                                 │
│                                    ▼                                 │
│                            Repository                               │
│                         .find({                                     │
│                           _organizationId,                          │
│                           _environmentId                            │
│                         })                                          │
│                                    │                                 │
│                                    ▼                                 │
│                             MongoDB                                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

*文档版本：1.0*  
*更新时间：2026-02-22*
