# I18n 模块技术规范

> 版本：1.0.0  
> 更新日期：2026-02-22

---

## 一、概述

### 1.1 模块定位

`@oksai/i18n` 提供国际化支持，基于 `nestjs-i18n`：

- **多语言支持**：支持多语言翻译文件
- **语言解析**：从请求头自动解析语言
- **动态模块**：灵活配置选项

### 1.2 技术栈

| 依赖 | 用途 |
|------|------|
| nestjs-i18n | NestJS 国际化集成 |
| TypeScript | 类型安全的翻译键 |

---

## 二、架构设计

### 2.1 模块结构

```
@oksai/i18n/
├── lib/
│   └── i18n.module.ts
└── index.ts

应用结构：
app/
├── i18n/
│   ├── zh/
│   │   ├── common.json
│   │   └── errors.json
│   └── en/
│       ├── common.json
│       └── errors.json
└── ...
```

---

## 三、使用方式

### 3.1 基本配置

```typescript
import * as path from 'node:path';
import { Module } from '@nestjs/common';
import { I18nModule } from '@oksai/i18n';

@Module({
  imports: [
    I18nModule.forRoot(path.join(__dirname, '..')),
  ],
})
export class AppModule {}
```

### 3.2 配置选项

```typescript
import { I18nModule } from '@oksai/i18n';

I18nModule.forRoot(path.join(__dirname, '..'), {
  // i18n 文件相对目录
  paths: ['i18n', 'locales'],

  // 默认语言
  fallbackLanguage: 'zh',

  // 语言 fallback 规则
  fallbacks: {
    'zh-CN': 'zh',
    'zh-TW': 'zh',
    'en-US': 'en',
    'en-GB': 'en',
  },

  // 自定义语言解析器
  resolvers: [
    { use: HeaderResolver, options: ['x-lang'] },
    new AcceptLanguageResolver({ matchType: 'strict-loose' }),
  ],
});
```

### 3.3 翻译文件结构

```
i18n/
├── zh/
│   ├── common.json
│   │   {
│   │     "welcome": "欢迎",
│   │     "goodbye": "再见"
│   │   }
│   └── errors.json
│       {
│         "not_found": "资源未找到",
│         "unauthorized": "未授权"
│       }
└── en/
    ├── common.json
    │   {
    │     "welcome": "Welcome",
    │     "goodbye": "Goodbye"
    │   }
    └── errors.json
        {
          "not_found": "Resource not found",
          "unauthorized": "Unauthorized"
        }
```

### 3.4 在控制器中使用

```typescript
import { Controller, Get } from '@nestjs/common';
import { I18n, I18nContext } from 'nestjs-i18n';

@Controller()
export class AppController {
  @Get()
  hello(@I18n() i18n: I18nContext) {
    // 简单翻译
    return i18n.t('common.welcome');

    // 带参数翻译
    return i18n.t('common.greeting', { args: { name: '张三' } }});
    // "你好，张三！"

    // 带复数
    return i18n.t('common.items', { args: { count: 5 } }});
    // "5 个项目"
  }
}
```

### 3.5 在服务中使用

```typescript
import { Injectable } from '@nestjs/common';
import { I18nService } from 'nestjs-i18n';

@Injectable()
export class NotificationService {
  constructor(private readonly i18n: I18nService) {}

  async sendWelcomeEmail(email: string, lang: string) {
    const subject = this.i18n.translate('emails.welcome.subject', { lang });
    const body = this.i18n.translate('emails.welcome.body', {
      lang,
      args: { email },
    });

    // 发送邮件...
  }
}
```

---

## 四、API 参考

### 4.1 I18nModule.forRoot

```typescript
interface I18nModuleOptions {
  /**
   * i18n 相对目录列表（相对于 baseDir）
   * @default ['i18n']
   */
  paths?: string[];

  /**
   * fallback 语言
   * @default 'zh'
   */
  fallbackLanguage?: string;

  /**
   * 语言 fallback 规则（例如 `zh-CN -> zh`）
   */
  fallbacks?: Record<string, string>;

  /**
   * 自定义语言解析器
   * @default [{ use: HeaderResolver, options: ['x-lang'] }, AcceptLanguageResolver]
   */
  resolvers?: I18nOptionResolver[];
}

function forRoot(
  baseDir: string,
  options?: I18nModuleOptions
): DynamicModule;
```

---

## 五、语言解析

### 5.1 默认解析顺序

1. **HeaderResolver**：从 `x-lang` 请求头读取
2. **AcceptLanguageResolver**：从 `Accept-Language` 请求头读取

### 5.2 自定义解析器

```typescript
import { I18nResolver } from 'nestjs-i18n';

class QueryResolver implements I18nResolver {
  resolve(context: ExecutionContext): string | undefined {
    const request = context.switchToHttp().getRequest();
    return request.query?.lang;
  }
}

I18nModule.forRoot(baseDir, {
  resolvers: [
    new QueryResolver(),
    { use: HeaderResolver, options: ['x-lang'] },
  ],
});
```

---

## 六、测试覆盖

| 指标 | 覆盖率 |
|------|--------|
| Statements | 100% |
| Branches | 90.9% |
| Functions | 100% |
| Lines | 100% |

---

## 七、最佳实践

### 7.1 翻译键命名

```json
// ✅ 好：按模块组织
{
  "users": {
    "create": "创建用户",
    "update": "更新用户",
    "delete": "删除用户"
  },
  "jobs": {
    "create": "创建任务",
    "status": {
      "pending": "待处理",
      "running": "运行中"
    }
  }
}

// ❌ 不好：扁平结构
{
  "create_user": "创建用户",
  "update_user": "更新用户",
  "create_job": "创建任务"
}
```

### 7.2 参数化翻译

```json
{
  "greeting": "你好，{name}！",
  "items_count": "{count} 个项目",
  "range": "从 {start} 到 {end}"
}
```

```typescript
i18n.t('greeting', { args: { name: '张三' } });
// "你好，张三！"
```

### 7.3 复数处理

```json
{
  "item_one": "{count} 个项目",
  "item_other": "{count} 个项目"
}
```
