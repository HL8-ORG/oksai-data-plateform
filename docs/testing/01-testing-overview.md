# 测试概述

[返回目录](./README.md)

---

## 一、测试类型分类

### 1.1 按测试范围分类

| 测试类型 | 范围 | 速度 | 数量占比 | 用途 |
|:---|:---|:---|:---|:---|
| **单元测试** | 单个函数/类 | 毫秒级 | 70% | 验证业务逻辑正确性 |
| **集成测试** | 多组件协作 | 秒级 | 20% | 验证组件间交互 |
| **E2E 测试** | 完整流程 | 分钟级 | 10% | 验证关键业务场景 |

### 1.2 按测试方法分类

| 方法 | 特点 | 代表工具 |
|:---|:---|:---|
| **TDD** | 测试驱动开发，先写测试再写代码 | Jest, Mocha |
| **BDD** | 行为驱动开发，用自然语言描述行为 | Cucumber, Jest |
| **传统测试** | 先写代码再写测试 | 所有测试框架 |

---

## 二、测试金字塔

### 2.1 金字塔原理

```
                    ┌─────────────┐
                    │   E2E 测试   │  
                    │   数量：少    │  关键业务流程验证
                    │   速度：慢    │  
                ┌───┴─────────────┴───┐
                │     集成测试         │  
                │     数量：适中        │  组件交互验证
                │     速度：较慢        │  
            ┌───┴─────────────────────┴───┐
            │         单元测试             │  
            │         数量：大量            │  业务规则验证
            │         速度：快              │  
            └─────────────────────────────┘
```

### 2.2 金字塔策略

```typescript
// 测试金字塔比例建议
const testPyramid = {
  unitTests: '70%',      // 大量快速、细粒度的测试
  integrationTests: '20%', // 测试组件间交互
  e2eTests: '10%'        // 少量关键业务场景测试
};
```

### 2.3 为什么遵循金字塔？

| 原因 | 说明 |
|:---|:---|
| **速度** | 底层测试越多，整体测试套件运行越快 |
| **稳定性** | 单元测试受外部影响小，更稳定 |
| **定位问题** | 单元测试失败能精确定位问题位置 |
| **成本** | 底层测试维护成本更低 |

---

## 三、TDD、BDD、单元测试的关系

### 3.1 概念定位

| 概念 | 类别 | 核心思想 | 回答的问题 |
|:---|:---|:---|:---|
| **TDD** | 开发流程/方法论 | 测试先于代码编写 | "如何保证代码的正确性？" |
| **BDD** | 设计方法/沟通工具 | 用业务语言描述行为 | "我们构建的是正确的产品吗？" |
| **单元测试** | 验证技术/工具 | 验证单个组件功能 | "这段代码正确吗？" |

### 3.2 关系图

```
┌─────────────────────────────────────────────────────┐
│                   开发方法论                         │
│  ┌─────────────────────────────────────────────┐   │
│  │              TDD（测试驱动开发）              │   │
│  │           红-绿-重构 循环                    │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                   设计方法                          │
│  ┌─────────────────────────────────────────────┐   │
│  │              BDD（行为驱动开发）              │   │
│  │         Given-When-Then 结构                 │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                   验证技术                          │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐      │
│  │ 单元测试   │  │ 集成测试   │  │ E2E测试   │      │
│  └───────────┘  └───────────┘  └───────────┘      │
└─────────────────────────────────────────────────────┘
```

### 3.3 一句话总结

- **BDD** 确保我们 **做正确的事**（验证需求）
- **TDD** 确保我们 **正确地做事**（指导设计）
- **单元测试** 确保我们 **做的事正确**（验证实现）

---

## 四、测试关注点对比

### 4.1 单元测试 vs BDD测试

| 维度 | 单元测试 | BDD测试 |
|:---|:---|:---|
| **关注点** | 代码的正确性 | 业务行为的正确性 |
| **思维方式** | "我的函数返回正确的结果吗？" | "系统按照业务规则运行吗？" |
| **语言风格** | 代码语言：`expect(result).toBe(expected)` | 自然语言：`Given...When...Then...` |
| **测试范围** | 单个组件/函数 | 功能特性/用户故事 |
| **受众** | 开发者 | 开发者 + 产品经理 + 业务人员 |

### 4.2 不同场景的关注点

| 场景 | 单元测试问 | BDD测试问 |
|:---|:---|:---|
| 订单提交 | 方法返回值正确吗？状态变更正确吗？ | 用户能成功下单吗？系统会通知仓库吗？ |
| 库存扣减 | 库存数量减少了吗？并发时数据一致吗？ | 用户不能买超过库存的商品吗？ |
| 价格计算 | 折扣计算正确吗？税费计算正确吗？ | 用户看到的价格包含所有费用吗？ |

---

## 五、何时使用什么测试？

| 场景 | 推荐测试类型 | 原因 |
|:---|:---|:---|
| 验证算法正确性 | 单元测试 | 快速、精确、覆盖边界条件 |
| 验证业务规则 | 单元测试 + BDD | 单元测试保证代码正确，BDD保证业务理解一致 |
| 验证数据库操作 | 集成测试 | 需要真实数据库验证 SQL |
| 验证跨服务交互 | 组件测试/E2E | 测试真实集成点 |
| 验收新功能 | BDD测试 | 业务人员可参与评审 |
| 回归测试 | 自动化单元测试 | 快速反馈、准确定位 |

---

## 六、测试命令配置

```json
// package.json
{
  "scripts": {
    "test:unit": "jest --testMatch='**/*.spec.ts' --testPathIgnorePatterns='.int-spec.ts|.e2e-spec.ts'",
    "test:integration": "jest --testMatch='**/*.int-spec.ts' --runInBand",
    "test:e2e": "jest --testMatch='**/*.e2e-spec.ts' --runInBand",
    "test:bdd": "cucumber-js features/**/*.feature",
    "test": "npm run test:unit && npm run test:integration && npm run test:e2e",
    "test:coverage": "jest --coverage"
  }
}
```

---

## 七、CI/CD 中的测试集成

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Unit Tests
        run: pnpm run test:unit  # 快速反馈
        
      - name: Integration Tests
        run: pnpm run test:integration  # 需要数据库
        
      - name: BDD Tests
        run: pnpm run test:bdd  # 业务验证
        
      - name: E2E Tests  
        run: pnpm run test:e2e  # 完整流程
        
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

---

[下一章：单元测试 →](./02-unit-testing.md)
